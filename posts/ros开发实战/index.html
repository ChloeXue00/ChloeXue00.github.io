<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>如何使用 C&#43;&#43; 编写一个 ROS 设备驱动节点 | </title>
<meta name="keywords" content="C&#43;&#43;, 传感器驱动, IMU, rosbag, 自动驾驶">
<meta name="description" content="通过本案例可以掌握：

如何使用 C&#43;&#43; 编写一个 ROS 设备驱动节点；
如何调试 ROS 发布频率、时间戳和消息内容；
如何结合 rosbag 与 rqt_plot 分析传感器数据的稳定性；
为后续多传感器时间同步与融合（如 EKF）打下基础。

🌐 多传感器融合中的 ROS 驱动开发实战案例
在自动驾驶系统中，IMU、GNSS 和雷达等传感器是实现环境感知和车辆定位的关键。本文以 ROS 框架为基础，讲解如何编写一个简单的传感器驱动节点，实现数据采集 → 解析 → 发布 → 可视化，并附带常见调试命令。

1. 项目结构
my_sensor_driver/
├── launch/
│   └── sensor_driver.launch
├── src/
│   └── imu_driver_node.cpp
├── include/
│   └── imu_driver.hpp
├── config/
│   └── imu_config.yaml
├── CMakeLists.txt
├── package.xml


my_sensor_driver： ROS package 根目录，所有内容都放在这里


launch/sensor_driver.launch：

ROS 的启动脚本，用 XML 格式描述：

启动哪个节点（node）
使用哪些参数文件（如 config/imu_config.yaml）
是否输出日志到屏幕等
用法：roslaunch my_sensor_driver sensor_driver.launch
示例：

&lt;launch&gt;
&lt;!-- 加载 IMU 参数配置 --&gt;
&lt;rosparam file=&#34;$(find my_sensor_driver)/config/imu_config.yaml&#34; command=&#34;load&#34;/&gt;

&lt;!-- 启动 IMU 驱动节点 --&gt;
&lt;node name=&#34;imu_driver&#34; pkg=&#34;my_sensor_driver&#34; type=&#34;imu_driver_node&#34; output=&#34;screen&#34;/&gt;
&lt;/launch&gt;




src/imu_driver_node.cpp">
<meta name="author" content="">
<link rel="canonical" href="//localhost:1313/posts/ros%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.f49d66caae9ea0fd43f21f29e71a8d3e284517ed770f2aa86fa012953ad3c9ef.css" integrity="sha256-9J1myq6eoP1D8h8p5xqNPihFF&#43;13Dyqob6ASlTrTye8=" rel="preload stylesheet" as="style">
<link rel="icon" href="//localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="//localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="//localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="//localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="//localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="//localhost:1313/posts/ros%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      如何使用 C&#43;&#43; 编写一个 ROS 设备驱动节点
    </h1>
    <div class="post-meta"><span title='2024-11-17 00:00:00 +0000 UTC'>November 17, 2024</span>

</div>
  </header> 
  <div class="post-content"><p>通过本案例可以掌握：</p>
<ul>
<li>如何使用 C++ 编写一个 ROS 设备驱动节点；</li>
<li>如何调试 ROS 发布频率、时间戳和消息内容；</li>
<li>如何结合 rosbag 与 rqt_plot 分析传感器数据的稳定性；</li>
<li>为后续多传感器时间同步与融合（如 EKF）打下基础。</li>
</ul>
<h1 id="-多传感器融合中的-ros-驱动开发实战案例">🌐 多传感器融合中的 ROS 驱动开发实战案例<a hidden class="anchor" aria-hidden="true" href="#-多传感器融合中的-ros-驱动开发实战案例">#</a></h1>
<p>在自动驾驶系统中，IMU、GNSS 和雷达等传感器是实现环境感知和车辆定位的关键。本文以 ROS 框架为基础，讲解如何编写一个简单的传感器驱动节点，实现数据采集 → 解析 → 发布 → 可视化，并附带常见调试命令。</p>
<hr>
<h2 id="1-项目结构">1. 项目结构<a hidden class="anchor" aria-hidden="true" href="#1-项目结构">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>my_sensor_driver/
</span></span><span style="display:flex;"><span>├── launch/
</span></span><span style="display:flex;"><span>│   └── sensor_driver.launch
</span></span><span style="display:flex;"><span>├── src/
</span></span><span style="display:flex;"><span>│   └── imu_driver_node.cpp
</span></span><span style="display:flex;"><span>├── include/
</span></span><span style="display:flex;"><span>│   └── imu_driver.hpp
</span></span><span style="display:flex;"><span>├── config/
</span></span><span style="display:flex;"><span>│   └── imu_config.yaml
</span></span><span style="display:flex;"><span>├── CMakeLists.txt
</span></span><span style="display:flex;"><span>├── package.xml
</span></span></code></pre></div><ul>
<li>
<p>my_sensor_driver： ROS package 根目录，所有内容都放在这里</p>
</li>
<li>
<p>launch/sensor_driver.launch：</p>
<ul>
<li>ROS 的启动脚本，用 XML 格式描述：
<ul>
<li>启动哪个节点（node）</li>
<li>使用哪些参数文件（如 config/imu_config.yaml）</li>
<li>是否输出日志到屏幕等</li>
<li>用法：<strong>roslaunch my_sensor_driver sensor_driver.launch</strong></li>
<li>示例：</li>
</ul>
<pre tabindex="0"><code class="language-launch" data-lang="launch">&lt;launch&gt;
&lt;!-- 加载 IMU 参数配置 --&gt;
&lt;rosparam file=&#34;$(find my_sensor_driver)/config/imu_config.yaml&#34; command=&#34;load&#34;/&gt;

&lt;!-- 启动 IMU 驱动节点 --&gt;
&lt;node name=&#34;imu_driver&#34; pkg=&#34;my_sensor_driver&#34; type=&#34;imu_driver_node&#34; output=&#34;screen&#34;/&gt;
&lt;/launch&gt;
</code></pre></li>
</ul>
</li>
<li>
<p>src/imu_driver_node.cpp</p>
</li>
<li>
<p>C++ 源码文件，实现如下功能：</p>
<ul>
<li>初始化 ROS 节点</li>
<li>串口读 IMU 数据</li>
<li>解析并发布为 /imu/data ROS 消息</li>
</ul>
</li>
<li>
<p>include/imu_driver.hpp： 头文件，通常用于：</p>
<ul>
<li>声明类 ImuDriver、函数、结构体等</li>
<li>和 cpp 分离，便于模块化、复用</li>
<li>如果项目简单也可以省略，用于“规范化”大型项目</li>
</ul>
</li>
<li>
<p>config/imu_config.yaml：参数配置文件，用于将 IMU 驱动的参数（如串口号、波特率、话题名等）外部化管理</p>
</li>
</ul>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">port</span>: <span style="color:#e6db74">&#34;/dev/ttyUSB0&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">baudrate</span>: <span style="color:#ae81ff">115200</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">frame_id</span>: <span style="color:#e6db74">&#34;imu_link&#34;</span>
</span></span></code></pre></div><p>在 sensor_driver.launch 中通过 <strong>rosparam</strong> 加载：</p>
<pre tabindex="0"><code class="language-launch" data-lang="launch">&lt;rosparam file=&#34;$(find my_sensor_driver)/config/imu_config.yaml&#34; command=&#34;load&#34;/&gt;
</code></pre><ul>
<li>CMakeLists.txt:ROS 的构建脚本:</li>
<li>作用：
<ul>
<li>编译 src/imu_driver_node.cpp → 可执行文件 imu_driver_node</li>
<li>指定依赖（如 sensor_msgs、roscpp）</li>
</ul>
</li>
<li>示例：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-txt" data-lang="txt"><span style="display:flex;"><span>cmake_minimum_required(VERSION 3.0.2)
</span></span><span style="display:flex;"><span>project(my_sensor_driver)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>## 编译类型设置
</span></span><span style="display:flex;"><span>add_compile_options(-std=c++11)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>## 查找依赖的包
</span></span><span style="display:flex;"><span>find_package(catkin REQUIRED COMPONENTS
</span></span><span style="display:flex;"><span>  roscpp
</span></span><span style="display:flex;"><span>  sensor_msgs
</span></span><span style="display:flex;"><span>  std_msgs
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>## 生成消息的路径设置
</span></span><span style="display:flex;"><span>catkin_package()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>include_directories(
</span></span><span style="display:flex;"><span>  include
</span></span><span style="display:flex;"><span>  ${catkin_INCLUDE_DIRS}
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>## 编译可执行文件
</span></span><span style="display:flex;"><span>add_executable(imu_driver_node src/imu_driver_node.cpp)
</span></span><span style="display:flex;"><span>target_link_libraries(imu_driver_node ${catkin_LIBRARIES})
</span></span></code></pre></div><p>package.xml: ROS 的包描述文件</p>
<ul>
<li>
<p>作用：</p>
<ul>
<li>
<p>告诉 ROS 这个包的名称、依赖库、作者信息等</p>
</li>
<li>
<p>配合 catkin_make 使用</p>
</li>
</ul>
</li>
</ul>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#75715e">&lt;?xml version=&#34;1.0&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;package</span> <span style="color:#a6e22e">format=</span><span style="color:#e6db74">&#34;2&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;name&gt;</span>my_sensor_driver<span style="color:#f92672">&lt;/name&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;version&gt;</span>0.0.1<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;description&gt;</span>Minimal ROS sensor driver package<span style="color:#f92672">&lt;/description&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;maintainer</span> <span style="color:#a6e22e">email=</span><span style="color:#e6db74">&#34;your_email@example.com&#34;</span><span style="color:#f92672">&gt;</span>Your Name<span style="color:#f92672">&lt;/maintainer&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;license&gt;</span>BSD<span style="color:#f92672">&lt;/license&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;buildtool_depend&gt;</span>catkin<span style="color:#f92672">&lt;/buildtool_depend&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;depend&gt;</span>roscpp<span style="color:#f92672">&lt;/depend&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;depend&gt;</span>sensor_msgs<span style="color:#f92672">&lt;/depend&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;depend&gt;</span>std_msgs<span style="color:#f92672">&lt;/depend&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;export&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/export&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/package&gt;</span>
</span></span></code></pre></div><p>使用 catkin_make打包与运行流程:</p>
<pre tabindex="0"><code>cd ~/catkin_ws
catkin_make
source devel/setup.bash
roslaunch my_sensor_driver sensor_driver.launch
</code></pre><p>TODO:
模拟 IMU 串口发送脚本（mock_imu_sender.py）
模拟 GNSS ROS 节点（mock_gnss_node.py）
EKF launch 文件</p>
<hr>
<h2 id="2-驱动逻辑核心srcimu_driver_nodecpp部分代码示例">2. 驱动逻辑核心（src/imu_driver_node.cpp部分代码示例）<a hidden class="anchor" aria-hidden="true" href="#2-驱动逻辑核心srcimu_driver_nodecpp部分代码示例">#</a></h2>
<p>实现读取串口数据并发布为 /imu/data 的逻辑</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;ros/ros.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sensor_msgs/Imu.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;serial/serial.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sstream&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 模拟解析函数：从原始字符串中提取四元数（实际应依据具体协议实现）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">parseIMUData</span>(<span style="color:#66d9ef">const</span> std<span style="color:#f92672">::</span>string<span style="color:#f92672">&amp;</span> raw, sensor_msgs<span style="color:#f92672">::</span>Imu<span style="color:#f92672">&amp;</span> imu_msg) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 示例数据: &#34;0.0,0.0,0.0,1.0&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    std<span style="color:#f92672">::</span>stringstream ss(raw);
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>string item;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> q[<span style="color:#ae81ff">4</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (std<span style="color:#f92672">::</span>getline(ss, item, <span style="color:#e6db74">&#39;,&#39;</span>) <span style="color:#f92672">&amp;&amp;</span> i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">4</span>) {
</span></span><span style="display:flex;"><span>        q[i<span style="color:#f92672">++</span>] <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span>stof(item);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    imu_msg.orientation.x <span style="color:#f92672">=</span> q[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span>    imu_msg.orientation.y <span style="color:#f92672">=</span> q[<span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>    imu_msg.orientation.z <span style="color:#f92672">=</span> q[<span style="color:#ae81ff">2</span>];
</span></span><span style="display:flex;"><span>    imu_msg.orientation.w <span style="color:#f92672">=</span> q[<span style="color:#ae81ff">3</span>];
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span><span style="color:#f92672">**</span> argv) {
</span></span><span style="display:flex;"><span>    ros<span style="color:#f92672">::</span>init(argc, argv, <span style="color:#e6db74">&#34;imu_driver_node&#34;</span>);
</span></span><span style="display:flex;"><span>    ros<span style="color:#f92672">::</span>NodeHandle nh;
</span></span><span style="display:flex;"><span>    ros<span style="color:#f92672">::</span>NodeHandle pnh(<span style="color:#e6db74">&#34;~&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>string port;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> baudrate;
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>string frame_id;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 获取参数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    pnh.param<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>string<span style="color:#f92672">&gt;</span>(<span style="color:#e6db74">&#34;port&#34;</span>, port, <span style="color:#e6db74">&#34;/dev/ttyUSB0&#34;</span>);
</span></span><span style="display:flex;"><span>    pnh.param<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span>(<span style="color:#e6db74">&#34;baudrate&#34;</span>, baudrate, <span style="color:#ae81ff">115200</span>);
</span></span><span style="display:flex;"><span>    pnh.param<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>string<span style="color:#f92672">&gt;</span>(<span style="color:#e6db74">&#34;frame_id&#34;</span>, frame_id, <span style="color:#e6db74">&#34;imu_link&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 初始化串口
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    serial<span style="color:#f92672">::</span>Serial ser;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>        ser.setPort(port);
</span></span><span style="display:flex;"><span>        ser.setBaudrate(baudrate);
</span></span><span style="display:flex;"><span>        serial<span style="color:#f92672">::</span>Timeout to <span style="color:#f92672">=</span> serial<span style="color:#f92672">::</span>Timeout<span style="color:#f92672">::</span>simpleTimeout(<span style="color:#ae81ff">1000</span>);
</span></span><span style="display:flex;"><span>        ser.setTimeout(to);
</span></span><span style="display:flex;"><span>        ser.open();
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">catch</span> (serial<span style="color:#f92672">::</span>IOException<span style="color:#f92672">&amp;</span> e) {
</span></span><span style="display:flex;"><span>        ROS_ERROR_STREAM(<span style="color:#e6db74">&#34;Unable to open port &#34;</span> <span style="color:#f92672">&lt;&lt;</span> port);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>ser.isOpen()) {
</span></span><span style="display:flex;"><span>        ROS_ERROR_STREAM(<span style="color:#e6db74">&#34;Serial port not opened.&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ros<span style="color:#f92672">::</span>Publisher imu_pub <span style="color:#f92672">=</span> nh.advertise<span style="color:#f92672">&lt;</span>sensor_msgs<span style="color:#f92672">::</span>Imu<span style="color:#f92672">&gt;</span>(<span style="color:#e6db74">&#34;/imu/data&#34;</span>, <span style="color:#ae81ff">50</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ROS_INFO_STREAM(<span style="color:#e6db74">&#34;IMU Driver Started on &#34;</span> <span style="color:#f92672">&lt;&lt;</span> port <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34; at &#34;</span> <span style="color:#f92672">&lt;&lt;</span> baudrate <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34; baudrate.&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ros<span style="color:#f92672">::</span>Rate loop_rate(<span style="color:#ae81ff">50</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (ros<span style="color:#f92672">::</span>ok()) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (ser.available()) {
</span></span><span style="display:flex;"><span>            std<span style="color:#f92672">::</span>string raw_data <span style="color:#f92672">=</span> ser.readline();
</span></span><span style="display:flex;"><span>            sensor_msgs<span style="color:#f92672">::</span>Imu imu_msg;
</span></span><span style="display:flex;"><span>            imu_msg.header.stamp <span style="color:#f92672">=</span> ros<span style="color:#f92672">::</span>Time<span style="color:#f92672">::</span>now();
</span></span><span style="display:flex;"><span>            imu_msg.header.frame_id <span style="color:#f92672">=</span> frame_id;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            parseIMUData(raw_data, imu_msg);
</span></span><span style="display:flex;"><span>            imu_pub.publish(imu_msg);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        ros<span style="color:#f92672">::</span>spinOnce();
</span></span><span style="display:flex;"><span>        loop_rate.sleep();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><hr>
<h2 id="-3-launch-文件示例">🚀 3. Launch 文件示例<a hidden class="anchor" aria-hidden="true" href="#-3-launch-文件示例">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;launch&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;node</span> <span style="color:#a6e22e">pkg=</span><span style="color:#e6db74">&#34;my_sensor_driver&#34;</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#34;imu_driver_node&#34;</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;imu_driver&#34;</span> <span style="color:#a6e22e">output=</span><span style="color:#e6db74">&#34;screen&#34;</span> <span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/launch&gt;</span>
</span></span></code></pre></div><hr>
<h2 id="4-常用-ros-调试命令推荐操作顺序">4. 常用 ROS 调试命令（推荐操作顺序）<a hidden class="anchor" aria-hidden="true" href="#4-常用-ros-调试命令推荐操作顺序">#</a></h2>
<table>
  <thead>
      <tr>
          <th>操作目的</th>
          <th>常用命令</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>查看 topic 发布频率</td>
          <td><code>rostopic hz /imu/data</code></td>
      </tr>
      <tr>
          <td>查看发布数据内容</td>
          <td><code>rostopic echo /imu/data</code></td>
      </tr>
      <tr>
          <td>查看所有活跃节点</td>
          <td><code>rosnode list</code></td>
      </tr>
      <tr>
          <td>检查节点状态</td>
          <td><code>rosnode info /imu_driver</code></td>
      </tr>
      <tr>
          <td>可视化数据</td>
          <td><code>rqt_plot /imu/data.orientation.x</code></td>
      </tr>
      <tr>
          <td>录制调试日志</td>
          <td><code>rosbag record -O imu_log.bag /imu/data</code></td>
      </tr>
      <tr>
          <td>播放 rosbag 日志</td>
          <td><code>rosbag play imu_log.bag</code></td>
      </tr>
  </tbody>
</table>
<hr>
<h2 id="5-延迟与频率验证技巧">5. 延迟与频率验证技巧<a hidden class="anchor" aria-hidden="true" href="#5-延迟与频率验证技巧">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 查看延迟（是否 timestamp 稳定）</span>
</span></span><span style="display:flex;"><span>rostopic echo -n <span style="color:#ae81ff">5</span> /imu/data | grep <span style="color:#e6db74">&#34;stamp&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 绘制数据间隔时间</span>
</span></span><span style="display:flex;"><span>rqt_plot /imu/data.header.stamp
</span></span></code></pre></div><hr>
<h2 id="6-总结">6. 总结<a hidden class="anchor" aria-hidden="true" href="#6-总结">#</a></h2>
<p>下一步是 整合 GNSS 数据，并使用 <code>message_filters::ApproximateTime</code> 实现 IMU + GNSS 时间同步。</p>
<h1 id="-gnss--imu-融合定位基于-ros--ekf">🛰️ GNSS + IMU 融合定位（基于 ROS + EKF）<a hidden class="anchor" aria-hidden="true" href="#-gnss--imu-融合定位基于-ros--ekf">#</a></h1>
<p>接下来这部分将介绍如何基于 ROS 框架将 GNSS 与 IMU 数据进行融合，利用 <code>robot_localization</code> 包中的 EKF 节点实现车辆位置估计，提高定位的鲁棒性和精度。</p>
<hr>
<h2 id="1-使用包依赖">1. 使用包依赖<a hidden class="anchor" aria-hidden="true" href="#1-使用包依赖">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo apt install ros-&lt;distro&gt;-robot-localization
</span></span></code></pre></div><hr>
<h2 id="2-数据准备">2. 数据准备<a hidden class="anchor" aria-hidden="true" href="#2-数据准备">#</a></h2>
<h3 id="输入数据">输入数据：<a hidden class="anchor" aria-hidden="true" href="#输入数据">#</a></h3>
<ul>
<li><code>/imu/data</code>：IMU 原始数据（方向、加速度）</li>
<li><code>/gps/fix</code>：GNSS 数据（<code>sensor_msgs/NavSatFix</code>）</li>
</ul>
<h3 id="可选增强数据">可选增强数据：<a hidden class="anchor" aria-hidden="true" href="#可选增强数据">#</a></h3>
<ul>
<li><code>/gps/vel</code>：GNSS 速度信息</li>
<li><code>/odometry/wheel</code>：轮速计（用于补偿 GNSS 信号丢失）</li>
</ul>
<hr>
<h2 id="3-ekf-节点配置文件ekfyaml">3. EKF 节点配置文件（ekf.yaml）<a hidden class="anchor" aria-hidden="true" href="#3-ekf-节点配置文件ekfyaml">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">frequency</span>: <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">sensor_timeout</span>: <span style="color:#ae81ff">0.1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">two_d_mode</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">publish_tf</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">map_frame</span>: <span style="color:#ae81ff">map</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">odom_frame</span>: <span style="color:#ae81ff">odom</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">base_link_frame</span>: <span style="color:#ae81ff">base_link</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">world_frame</span>: <span style="color:#ae81ff">odom</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">imu0</span>: <span style="color:#ae81ff">/imu/data</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">imu0_config</span>: [<span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">true</span>, <span style="color:#66d9ef">true</span>, <span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">false</span>]
</span></span><span style="display:flex;"><span><span style="color:#f92672">imu0_differential</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">imu0_remove_gravitational_acceleration</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">gps0</span>: <span style="color:#ae81ff">/gps/fix</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">gps0_config</span>: [<span style="color:#66d9ef">true</span>, <span style="color:#66d9ef">true</span>, <span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">false</span>]
</span></span><span style="display:flex;"><span><span style="color:#f92672">gps0_differential</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">use_control</span>: <span style="color:#66d9ef">false</span>
</span></span></code></pre></div><hr>
<h2 id="4-启动文件ekf_fusionlaunch">4. 启动文件（ekf_fusion.launch）<a hidden class="anchor" aria-hidden="true" href="#4-启动文件ekf_fusionlaunch">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;launch&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;node</span> <span style="color:#a6e22e">pkg=</span><span style="color:#e6db74">&#34;robot_localization&#34;</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#34;ekf_localization_node&#34;</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;ekf_localization&#34;</span> <span style="color:#a6e22e">output=</span><span style="color:#e6db74">&#34;screen&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;param</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;~config&#34;</span> <span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#34;$(find your_package)/config/ekf.yaml&#34;</span> <span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/node&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/launch&gt;</span>
</span></span></code></pre></div><hr>
<h2 id="5-可视化与验证">5. 可视化与验证<a hidden class="anchor" aria-hidden="true" href="#5-可视化与验证">#</a></h2>
<h3 id="推荐指令">推荐指令：<a hidden class="anchor" aria-hidden="true" href="#推荐指令">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 查看定位融合结果</span>
</span></span><span style="display:flex;"><span>rostopic echo /odometry/filtered
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 用 rviz 显示路径轨迹</span>
</span></span><span style="display:flex;"><span>rviz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 对比 GNSS 原始与 EKF 融合输出</span>
</span></span><span style="display:flex;"><span>rqt_plot /gps/fix/latitude /odometry/filtered/pose/pose/position/x
</span></span></code></pre></div><hr>
<h2 id="6-问题排查建议">6. 问题排查建议<a hidden class="anchor" aria-hidden="true" href="#6-问题排查建议">#</a></h2>
<table>
  <thead>
      <tr>
          <th>问题</th>
          <th>原因</th>
          <th>解决建议</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>融合输出跳变 / 无输出</td>
          <td>时间戳不一致</td>
          <td>确保所有话题时间同步（使用 rosbag + <code>--clock</code>）</td>
      </tr>
      <tr>
          <td>EKF 输出延迟大</td>
          <td>频率设置太低或topic不活跃</td>
          <td>增加 <code>frequency</code>，确认输入话题活跃</td>
      </tr>
      <tr>
          <td>数据漂移严重</td>
          <td>IMU 重力未剔除</td>
          <td>设置 <code>imu0_remove_gravitational_acceleration: true</code></td>
      </tr>
      <tr>
          <td>融合失败报错</td>
          <td>配置字段顺序错误</td>
          <td>检查每个 <code>*_config</code> 数组长度为15，顺序严格</td>
      </tr>
  </tbody>
</table>
<hr>
<h2 id="7-总结">7. 总结<a hidden class="anchor" aria-hidden="true" href="#7-总结">#</a></h2>
<p>通过本案例，我们可以掌握：</p>
<ul>
<li>使用 <code>robot_localization</code> 进行 GNSS + IMU 融合定位；</li>
<li>如何配置 EKF 参数以适配不同传感器特性；</li>
<li>如何通过 rviz / rqt_plot 进行融合结果验证；</li>
<li>以及时间同步、漂移修正等常见问题的处理方法。</li>
</ul>
<p>下一步我们可以尝试加入轮速计、视觉里程计等，进行三传感器融合。</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="//localhost:1313/tags/c&#43;&#43;/">C&#43;&#43;</a></li>
      <li><a href="//localhost:1313/tags/%E4%BC%A0%E6%84%9F%E5%99%A8%E9%A9%B1%E5%8A%A8/">传感器驱动</a></li>
      <li><a href="//localhost:1313/tags/imu/">IMU</a></li>
      <li><a href="//localhost:1313/tags/rosbag/">Rosbag</a></li>
      <li><a href="//localhost:1313/tags/%E8%87%AA%E5%8A%A8%E9%A9%BE%E9%A9%B6/">自动驾驶</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<script src="/js/cursor-effects.js"></script>
<script>
  new CursorEffects({
    size: 2,
    shape: 'star',
    zIndex: 9999,
  });
</script>
</body>

</html>
